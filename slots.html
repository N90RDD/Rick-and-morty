<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sci-Fi Slots Prototype (with multiple bonus games)</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121a33;
      --panel2: #0f1630;
      --text: #e7ecff;
      --muted: #a8b3e6;
      --accent: #6cf5c2;
      --warn: #ffcc66;
      --bad: #ff6b6b;
      --good: #6cf58e;
      --line: rgba(255,255,255,.10);
      --shadow: rgba(0,0,0,.35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    body{
      margin:0; background: radial-gradient(800px 500px at 20% 10%, #153060 0%, var(--bg) 60%);
      color:var(--text); font-family:var(--sans);
      display:flex; justify-content:center; padding:22px;
    }
    .app{ width:min(1020px, 100%); }
    .top{
      display:flex; gap:14px; align-items:stretch; flex-wrap:wrap;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 12px 30px var(--shadow);
    }
    .header{
      padding:14px 16px; display:flex; justify-content:space-between; align-items:center;
    }
    .title{
      font-size:16px; letter-spacing:.3px;
    }
    .subtitle{
      font-family: var(--mono); color:var(--muted); font-size:12px;
    }
    .grid{
      display:grid; grid-template-columns: 1fr 330px; gap:14px; margin-top:14px;
    }
    .left{ padding:16px; }
    .right{ padding:16px; }

    .reels{
      background: rgba(0,0,0,.25);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:10px;
      position:relative;
      overflow:hidden;
    }

    .reel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      border:1px solid var(--line);
      border-radius: 12px;
      padding:8px;
      display:grid;
      grid-template-rows: repeat(3, 1fr);
      gap:8px;
      min-height: 210px;
    }

    .cell{
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-weight:800;
      font-size: 22px;
      letter-spacing: .5px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(16,24,48,.55);
      user-select:none;
      position:relative;
      overflow:hidden;
      min-height: 58px;
    }

    .cell .small{ display:block; font-size:11px; opacity:.85; font-weight:700; }
    .cell.win{
      outline:2px solid var(--accent);
      box-shadow: 0 0 0 4px rgba(108,245,194,.15), 0 0 25px rgba(108,245,194,.15) inset;
    }
    .cell.scatter{
      outline:2px solid var(--warn);
      box-shadow: 0 0 0 4px rgba(255,204,102,.12), 0 0 25px rgba(255,204,102,.10) inset;
    }
    .cell.wild{
      outline:2px solid #b88cff;
      box-shadow: 0 0 0 4px rgba(184,140,255,.12), 0 0 25px rgba(184,140,255,.12) inset;
    }

    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:14px;
    }
    button{
      background: linear-gradient(180deg, rgba(108,245,194,.25), rgba(108,245,194,.05));
      border:1px solid rgba(108,245,194,.45);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      font-weight:800;
      cursor:pointer;
      transition: transform .05s ease, filter .15s ease;
    }
    button:active{ transform: translateY(1px); }
    button.secondary{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      border:1px solid var(--line);
      color: var(--text);
      font-weight:700;
    }
    button.danger{
      background: linear-gradient(180deg, rgba(255,107,107,.22), rgba(255,107,107,.06));
      border:1px solid rgba(255,107,107,.45);
    }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .statrow{
      display:grid; grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    .stat{
      background: rgba(0,0,0,.22);
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px 12px;
    }
    .stat .k{ font-size:12px; color:var(--muted); }
    .stat .v{ font-size:18px; font-weight:900; margin-top:2px; font-family:var(--mono); }

    .log{
      margin-top:12px;
      background: rgba(0,0,0,.22);
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px 12px;
      max-height: 260px;
      overflow:auto;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
      white-space: pre-wrap;
    }

    .paytable{
      margin-top:12px;
      background: rgba(0,0,0,.22);
      border:1px solid var(--line);
      border-radius: 12px;
      padding:10px 12px;
      font-size: 12px;
      color: var(--muted);
    }
    .paytable h4{
      margin:0 0 8px; color:var(--text); font-size: 13px;
    }
    .paytable code{ color: var(--text); }

    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index: 50;
    }
    .modal{
      width:min(780px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 16px;
      display:flex; justify-content:space-between; align-items:center;
      background: rgba(0,0,0,.22);
      border-bottom:1px solid var(--line);
    }
    .modalBody{ padding:16px; }
    .tag{
      display:inline-flex; align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius: 999px;
      font-size: 12px;
      border:1px solid var(--line);
      color: var(--muted);
      background: rgba(0,0,0,.18);
      font-family: var(--mono);
    }
    .bonusGrid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:12px;
    }
    .pick{
      padding:14px 10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      cursor:pointer;
      user-select:none;
      text-align:center;
      font-weight:900;
      letter-spacing:.3px;
      min-height: 70px;
      display:flex; align-items:center; justify-content:center;
      position:relative;
      overflow:hidden;
    }
    .pick.revealed{
      cursor:default;
      opacity:.95;
      outline:2px solid rgba(108,245,194,.55);
      box-shadow: 0 0 0 4px rgba(108,245,194,.12);
    }
    .muted{ color: var(--muted); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .hr{ height:1px; background: var(--line); margin:12px 0; }

    .wheel{
      width: 260px; height:260px;
      border-radius: 50%;
      border:1px solid var(--line);
      background: conic-gradient(
        rgba(108,245,194,.35),
        rgba(255,204,102,.25),
        rgba(184,140,255,.28),
        rgba(255,107,107,.22),
        rgba(108,245,194,.35)
      );
      margin: 10px auto 6px;
      position:relative;
      display:flex;
      align-items:center; justify-content:center;
      box-shadow: 0 20px 40px rgba(0,0,0,.35);
    }
    .wheel::after{
      content:"";
      position:absolute; inset: 16px;
      border-radius: 50%;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
    }
    .pointer{
      width:0; height:0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 18px solid var(--accent);
      margin: 0 auto;
      filter: drop-shadow(0 6px 6px rgba(0,0,0,.35));
    }
    .wheelLabel{
      position:absolute;
      z-index:2;
      font-family: var(--mono);
      font-weight:900;
      color: var(--text);
      text-shadow: 0 2px 10px rgba(0,0,0,.5);
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card header">
      <div>
        <div class="title">Sci-Fi Slots Prototype</div>
        <div class="subtitle">5√ó3, paylines, wild/scatter, and 3 different bonus games</div>
      </div>
      <div class="tag">RNG ‚Ä¢ Demo</div>
    </div>

    <div class="grid">
      <div class="card left">
        <div class="reels" id="reels"></div>

        <div class="controls">
          <button id="spinBtn">SPIN</button>
          <button class="secondary" id="maxBetBtn">MAX BET</button>
          <button class="secondary" id="auto10Btn">AUTO √ó10</button>
          <button class="danger" id="resetBtn">RESET</button>
        </div>

        <div class="paytable">
          <h4>Paytable (per line)</h4>
          <div>Match from reel 1 ‚Üí right. Wild substitutes (not for Scatter).</div>
          <div class="hr"></div>
          <div><code>A</code>: 3=5√ó, 4=15√ó, 5=40√ó</div>
          <div><code>B</code>: 3=4√ó, 4=12√ó, 5=30√ó</div>
          <div><code>C</code>: 3=3√ó, 4=9√ó, 5=22√ó</div>
          <div><code>D</code>: 3=2√ó, 4=7√ó, 5=16√ó</div>
          <div><code>E</code>: 3=1√ó, 4=5√ó, 5=12√ó</div>
          <div class="hr"></div>
          <div><code>WILD</code>: substitutes for A‚ÄìE</div>
          <div><code>SCATTER</code>: 3+ triggers a random bonus game (anywhere)</div>
        </div>
      </div>

      <div class="card right">
        <div class="statrow">
          <div class="stat">
            <div class="k">Balance</div>
            <div class="v" id="bal">1000</div>
          </div>
          <div class="stat">
            <div class="k">Bet / spin</div>
            <div class="v" id="bet">10</div>
          </div>
          <div class="stat">
            <div class="k">Last win</div>
            <div class="v" id="lastWin">0</div>
          </div>
          <div class="stat">
            <div class="k">Lines</div>
            <div class="v" id="lines">10</div>
          </div>
        </div>

        <div class="log" id="log"></div>
      </div>
    </div>

    <!-- BONUS MODAL -->
    <div class="modalBackdrop" id="modalBackdrop">
      <div class="modal">
        <div class="modalHead">
          <div>
            <div class="title" id="bonusTitle">Bonus</div>
            <div class="subtitle" id="bonusSub">Pick stuff</div>
          </div>
          <button class="secondary" id="closeBonusBtn">Close</button>
        </div>
        <div class="modalBody" id="bonusBody"></div>
      </div>
    </div>

<script>
(() => {
  // -----------------------------
  // Core config
  // -----------------------------
  const REELS = 5;
  const ROWS = 3;

  // Symbol set (theme-neutral)
  const SYM = {
    A: { key:'A', label:'A', weight: 18 },
    B: { key:'B', label:'B', weight: 20 },
    C: { key:'C', label:'C', weight: 22 },
    D: { key:'D', label:'D', weight: 24 },
    E: { key:'E', label:'E', weight: 26 },
    W: { key:'W', label:'WILD', weight: 6 },
    S: { key:'S', label:'SCAT', weight: 4 },
  };

  // Payout multipliers per line for 3/4/5 of a kind.
  const PAY = {
    A: {3:5, 4:15, 5:40},
    B: {3:4, 4:12, 5:30},
    C: {3:3, 4:9,  5:22},
    D: {3:2, 4:7,  5:16},
    E: {3:1, 4:5,  5:12},
  };

  // 10 lines: (row indices for each reel)
  // 0=top,1=mid,2=bottom
  const LINES = [
    [1,1,1,1,1], // middle
    [0,0,0,0,0], // top
    [2,2,2,2,2], // bottom
    [0,1,2,1,0], // V
    [2,1,0,1,2], // inverted V
    [0,0,1,0,0],
    [2,2,1,2,2],
    [1,0,0,0,1],
    [1,2,2,2,1],
    [0,1,1,1,2],
  ];

  // -----------------------------
  // State
  // -----------------------------
  const state = {
    balance: 1000,
    bet: 10,
    lines: 10,
    lastWin: 0,
    spinning: false,
    grid: makeEmptyGrid(),
    autoLeft: 0,
  };

  // -----------------------------
  // DOM
  // -----------------------------
  const reelsEl = document.getElementById('reels');
  const balEl = document.getElementById('bal');
  const betEl = document.getElementById('bet');
  const linesEl = document.getElementById('lines');
  const lastWinEl = document.getElementById('lastWin');
  const logEl = document.getElementById('log');
  const spinBtn = document.getElementById('spinBtn');
  const maxBetBtn = document.getElementById('maxBetBtn');
  const auto10Btn = document.getElementById('auto10Btn');
  const resetBtn = document.getElementById('resetBtn');

  const modalBackdrop = document.getElementById('modalBackdrop');
  const bonusTitle = document.getElementById('bonusTitle');
  const bonusSub = document.getElementById('bonusSub');
  const bonusBody = document.getElementById('bonusBody');
  const closeBonusBtn = document.getElementById('closeBonusBtn');

  // -----------------------------
  // Utils
  // -----------------------------
  function makeEmptyGrid(){
    return Array.from({length: REELS}, () => Array.from({length: ROWS}, () => SYM.E.key));
  }

  function log(msg){
    const ts = new Date().toLocaleTimeString();
    logEl.textContent = `[${ts}] ${msg}\n` + logEl.textContent;
  }

  function updateHUD(){
    balEl.textContent = state.balance;
    betEl.textContent = state.bet;
    linesEl.textContent = state.lines;
    lastWinEl.textContent = state.lastWin;
  }

  // Weighted random pick from symbols
  const symbolBag = (() => {
    const entries = Object.values(SYM);
    const total = entries.reduce((a,s)=>a+s.weight,0);
    return { entries, total };
  })();

  function randInt(min, max){
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function pickSymbol(){
    let r = Math.random() * symbolBag.total;
    for(const s of symbolBag.entries){
      r -= s.weight;
      if(r <= 0) return s.key;
    }
    return SYM.E.key;
  }

  // -----------------------------
  // Rendering
  // -----------------------------
  function renderGrid(highlights = null){
    reelsEl.innerHTML = '';

    for(let c=0; c<REELS; c++){
      const reel = document.createElement('div');
      reel.className = 'reel';

      for(let r=0; r<ROWS; r++){
        const sym = state.grid[c][r];
        const cell = document.createElement('div');
        cell.className = 'cell';

        if(sym === 'W') cell.classList.add('wild');
        if(sym === 'S') cell.classList.add('scatter');

        if(highlights?.has(`${c},${r}`)) cell.classList.add('win');

        const pretty = (sym === 'W') ? 'üåÄ' : (sym === 'S' ? '‚ú®' : sym);
        const name = (sym === 'W') ? 'WILD' : (sym === 'S' ? 'SCATTER' : `SYMBOL ${sym}`);
        cell.innerHTML = `${pretty}<span class="small">${name}</span>`;
        reel.appendChild(cell);
      }
      reelsEl.appendChild(reel);
    }
  }

  // -----------------------------
  // Game logic
  // -----------------------------
  function spin(){
    if(state.spinning) return;
    const cost = state.bet;
    if(state.balance < cost){
      log(`Not enough balance to spin. Need ${cost}.`);
      return;
    }

    state.spinning = true;
    setButtons();

    // "Spin animation" (fake) by rapidly re-rolling columns
    const start = performance.now();
    const duration = 650;

    const anim = (t) => {
      const p = Math.min(1, (t - start) / duration);
      // update columns gradually
      for(let c=0; c<REELS; c++){
        if(p < (c+1)/REELS){
          // still "spinning" this column
          for(let r=0; r<ROWS; r++) state.grid[c][r] = pickSymbol();
        }
      }
      renderGrid();
      if(p < 1) requestAnimationFrame(anim);
      else finishSpin();
    };
    requestAnimationFrame(anim);

    state.balance -= cost;
    updateHUD();
  }

  function finishSpin(){
    // Finalize full grid
    for(let c=0; c<REELS; c++){
      for(let r=0; r<ROWS; r++) state.grid[c][r] = pickSymbol();
    }

    const { win, highlights, lineWins } = evaluateLines();
    const scatters = countSymbol('S');
    const hasBonus = scatters >= 3;

    state.lastWin = win;
    state.balance += win;

    renderGrid(highlights);
    updateHUD();

    if(lineWins.length){
      log(`Line wins: ${lineWins.map(x => `L${x.line+1}:${x.kind}√ó${x.mult}`).join(' | ')} ‚Üí +${win}`);
    } else {
      log(`No line win.`);
    }

    if(hasBonus){
      log(`‚ú® Scatter bonus triggered (${scatters} scatters)! Launching a random bonus game...`);
      // launch a random bonus and award extra winnings
      openRandomBonus(scatters).then((bonusWin) => {
        state.balance += bonusWin;
        state.lastWin += bonusWin;
        updateHUD();
        log(`BONUS paid +${bonusWin}. Total last win: ${state.lastWin}.`);
        endSpin();
      });
      return;
    }

    endSpin();
  }

  function endSpin(){
    state.spinning = false;
    setButtons();

    if(state.autoLeft > 0){
      state.autoLeft--;
      setButtons();
      // small delay so it feels like auto-spin
      setTimeout(() => {
        if(state.autoLeft > 0) spin();
        else setButtons();
      }, 280);
    }
  }

  function setButtons(){
    spinBtn.disabled = state.spinning || state.autoLeft > 0;
    maxBetBtn.disabled = state.spinning || state.autoLeft > 0;
    resetBtn.disabled = state.spinning;
    auto10Btn.disabled = state.spinning;

    auto10Btn.textContent = state.autoLeft > 0 ? `AUTO (${state.autoLeft} left)` : `AUTO √ó10`;
  }

  function countSymbol(k){
    let n = 0;
    for(let c=0; c<REELS; c++){
      for(let r=0; r<ROWS; r++){
        if(state.grid[c][r] === k) n++;
      }
    }
    return n;
  }

  function evaluateLines(){
    let totalWin = 0;
    const highlights = new Set();
    const lineWins = [];

    for(let i=0; i<state.lines; i++){
      const path = LINES[i];
      const lineSyms = path.map((row, col) => state.grid[col][row]);

      const result = evaluateLineSymbols(lineSyms);
      if(result.win > 0){
        totalWin += result.win;

        // mark winning positions (counted symbols)
        for(let col=0; col<result.count; col++){
          const row = path[col];
          highlights.add(`${col},${row}`);
        }

        lineWins.push({
          line: i,
          kind: result.kind,
          count: result.count,
          mult: result.mult,
          win: result.win
        });
      }
    }

    return { win: totalWin, highlights, lineWins };
  }

  // Evaluate a single line‚Äôs 5 symbols left->right.
  // Wild substitutes; scatter does not contribute to line wins.
  function evaluateLineSymbols(syms){
    // Determine "base" symbol: first non-wild, non-scatter symbol
    let base = null;
    for(const s of syms){
      if(s === 'S') break;      // scatter blocks line continuation for this simple model
      if(s !== 'W'){
        base = s;
        break;
      }
    }
    if(!base || !PAY[base]) return { win:0 };

    // Count matching from left
    let count = 0;
    for(const s of syms){
      if(s === 'S') break;
      if(s === base || s === 'W') count++;
      else break;
    }

    if(count < 3) return { win:0 };

    const mult = PAY[base][count] ?? 0;
    const win = mult * state.bet; // bet is total bet per spin in this demo
    return { win, kind: base, count, mult };
  }

  // -----------------------------
  // Bonus games (multiple)
  // -----------------------------
  function openModal(){
    modalBackdrop.style.display = 'flex';
  }
  function closeModal(){
    modalBackdrop.style.display = 'none';
    bonusBody.innerHTML = '';
  }

  closeBonusBtn.addEventListener('click', () => closeModal());

  // Returns Promise<number> bonusWin
  function openRandomBonus(scatterCount){
    // scatterCount could scale the bonus: more scatters = more picks / bigger base
    const bonusId = randInt(1, 3);
    if(bonusId === 1) return bonusPortalPick(scatterCount);
    if(bonusId === 2) return bonusPlumbusHunt(scatterCount);
    return bonusMeeseeksWheel(scatterCount);
  }

  // Bonus 1: Portal Pick (pick N portals; each reveals coin prize)
  function bonusPortalPick(scatterCount){
    return new Promise((resolve) => {
      openModal();
      bonusTitle.textContent = 'BONUS: Portal Pick';
      bonusSub.textContent = `Pick portals to collect coins. (${scatterCount} scatters = more picks)`;

      const picks = Math.min(6, 2 + scatterCount); // 5 scatters => 6 picks max
      let picksLeft = picks;
      let total = 0;

      bonusBody.innerHTML = `
        <div class="row">
          <div class="tag">Picks: <span id="picksLeft">${picksLeft}</span></div>
          <div class="tag">Bonus Total: <span id="bonusTotal">${total}</span></div>
          <div class="tag muted">Click a portal</div>
        </div>
        <div class="bonusGrid" id="grid"></div>
        <div class="hr"></div>
        <button id="finishBtn" class="secondary" disabled>Finish</button>
      `;

      const picksLeftEl = document.getElementById('picksLeft');
      const bonusTotalEl = document.getElementById('bonusTotal');
      const gridEl = document.getElementById('grid');
      const finishBtn = document.getElementById('finishBtn');

      const tiles = 12;
      const prizes = [];
      // Create prize pool
      for(let i=0;i<tiles;i++){
        // prize scales with bet and scatters
        const base = state.bet * (scatterCount >= 4 ? 3 : 2);
        const prize = base * randInt(1, 8);
        prizes.push(prize);
      }

      for(let i=0;i<tiles;i++){
        const div = document.createElement('div');
        div.className = 'pick';
        div.textContent = 'üåÄ PORTAL';
        div.addEventListener('click', () => {
          if(div.classList.contains('revealed')) return;
          if(picksLeft <= 0) return;

          div.classList.add('revealed');
          const win = prizes[i];
          total += win;
          picksLeft--;

          div.textContent = `+${win}`;
          picksLeftEl.textContent = picksLeft;
          bonusTotalEl.textContent = total;

          if(picksLeft <= 0){
            finishBtn.disabled = false;
          }
        });
        gridEl.appendChild(div);
      }

      finishBtn.addEventListener('click', () => {
        closeModal();
        resolve(total);
      });
    });
  }

  // Bonus 2: Plumbus Hunt (find multipliers; applies to a base award)
  function bonusPlumbusHunt(scatterCount){
    return new Promise((resolve) => {
      openModal();
      bonusTitle.textContent = 'BONUS: Plumbus Hunt';
      bonusSub.textContent = 'Find multipliers. Your total multiplier applies to a base award.';

      const picks = Math.min(5, 1 + scatterCount); // 3 scatters => 4 picks, 5 scatters => 5 picks
      let picksLeft = picks;
      let totalMult = 1;

      const baseAward = state.bet * (10 + scatterCount * 5); // scales with scatters

      bonusBody.innerHTML = `
        <div class="row">
          <div class="tag">Base: <span id="baseAward">${baseAward}</span></div>
          <div class="tag">Picks: <span id="picksLeft">${picksLeft}</span></div>
          <div class="tag">Multiplier: √ó<span id="mult">${totalMult}</span></div>
        </div>
        <div class="bonusGrid" id="grid"></div>
        <div class="hr"></div>
        <button id="finishBtn" class="secondary" disabled>Finish</button>
      `;

      const baseAwardEl = document.getElementById('baseAward');
      const picksLeftEl = document.getElementById('picksLeft');
      const multEl = document.getElementById('mult');
      const gridEl = document.getElementById('grid');
      const finishBtn = document.getElementById('finishBtn');

      baseAwardEl.textContent = baseAward;

      const tiles = 12;
      const multPool = [];
      for(let i=0;i<tiles;i++){
        // 1x-6x, weighted towards smaller
        const roll = randInt(1, 100);
        let m = 1;
        if(roll > 92) m = 6;
        else if(roll > 82) m = 5;
        else if(roll > 68) m = 4;
        else if(roll > 48) m = 3;
        else if(roll > 25) m = 2;
        multPool.push(m);
      }

      for(let i=0;i<tiles;i++){
        const div = document.createElement('div');
        div.className = 'pick';
        div.textContent = 'üîé SEARCH';
        div.addEventListener('click', () => {
          if(div.classList.contains('revealed')) return;
          if(picksLeft <= 0) return;

          div.classList.add('revealed');
          const m = multPool[i];
          totalMult *= m;
          picksLeft--;

          div.textContent = `√ó${m}`;
          picksLeftEl.textContent = picksLeft;
          multEl.textContent = totalMult;

          if(picksLeft <= 0){
            finishBtn.disabled = false;
          }
        });
        gridEl.appendChild(div);
      }

      finishBtn.addEventListener('click', () => {
        const win = baseAward * totalMult;
        closeModal();
        resolve(win);
      });
    });
  }

  // Bonus 3: Meeseeks Mayhem Wheel (spin wheel for multiplier; repeats N times, sum wins)
  function bonusMeeseeksWheel(scatterCount){
    return new Promise((resolve) => {
      openModal();
      bonusTitle.textContent = 'BONUS: Meeseeks Mayhem';
      bonusSub.textContent = 'Spin for multipliers. Each spin pays (bet √ó multiplier).';

      const spins = Math.min(6, scatterCount + 1); // 3 scatters => 4 spins
      let spinsLeft = spins;
      let total = 0;

      const wedges = [
        {m: 2, weight: 22},
        {m: 3, weight: 20},
        {m: 4, weight: 18},
        {m: 5, weight: 14},
        {m: 8, weight: 10},
        {m: 10, weight: 8},
        {m: 15, weight: 5},
        {m: 25, weight: 3},
      ];
      const totalW = wedges.reduce((a,w)=>a+w.weight,0);

      function pickWedge(){
        let r = Math.random()*totalW;
        for(const w of wedges){
          r -= w.weight;
          if(r <= 0) return w.m;
        }
        return 2;
      }

      bonusBody.innerHTML = `
        <div class="row">
          <div class="tag">Spins left: <span id="spinsLeft">${spinsLeft}</span></div>
          <div class="tag">Total: <span id="total">${total}</span></div>
          <div class="tag muted">Tap ‚ÄúSpin Wheel‚Äù</div>
        </div>
        <div class="pointer"></div>
        <div class="wheel" id="wheel">
          <div class="wheelLabel" id="wheelLabel">√ó?</div>
        </div>
        <div class="row" style="justify-content:center; margin-top:10px;">
          <button id="spinWheelBtn">SPIN WHEEL</button>
          <button id="finishBtn" class="secondary" disabled>Finish</button>
        </div>
        <div class="hr"></div>
        <div class="muted" style="font-family:var(--mono); font-size:12px;">
          Payout per spin = bet (${state.bet}) √ó multiplier
        </div>
      `;

      const spinsLeftEl = document.getElementById('spinsLeft');
      const totalEl = document.getElementById('total');
      const wheel = document.getElementById('wheel');
      const wheelLabel = document.getElementById('wheelLabel');
      const spinWheelBtn = document.getElementById('spinWheelBtn');
      const finishBtn = document.getElementById('finishBtn');

      let rotating = false;

      spinWheelBtn.addEventListener('click', () => {
        if(rotating) return;
        if(spinsLeft <= 0) return;

        rotating = true;
        spinWheelBtn.disabled = true;

        const m = pickWedge();
        const win = state.bet * m;
        total += win;
        spinsLeft--;

        // Simple rotation animation
        const deg = 720 + randInt(0, 360);
        wheel.style.transition = 'transform 1.1s cubic-bezier(.12,.8,.12,1)';
        wheel.style.transform = `rotate(${deg}deg)`;

        setTimeout(() => {
          wheel.style.transition = '';
          wheel.style.transform = `rotate(${deg % 360}deg)`;
          wheelLabel.textContent = `√ó${m}  (+${win})`;
          spinsLeftEl.textContent = spinsLeft;
          totalEl.textContent = total;

          rotating = false;
          spinWheelBtn.disabled = false;

          if(spinsLeft <= 0){
            spinWheelBtn.disabled = true;
            finishBtn.disabled = false;
          }
        }, 1150);
      });

      finishBtn.addEventListener('click', () => {
        closeModal();
        resolve(total);
      });
    });
  }

  // -----------------------------
  // Controls
  // -----------------------------
  spinBtn.addEventListener('click', spin);

  maxBetBtn.addEventListener('click', () => {
    if(state.spinning || state.autoLeft > 0) return;
    state.bet = 25;
    updateHUD();
    log(`Max bet set: ${state.bet}`);
  });

  auto10Btn.addEventListener('click', () => {
    if(state.spinning) return;
    if(state.autoLeft > 0){
      state.autoLeft = 0;
      log('Auto-spin stopped.');
      setButtons();
      return;
    }
    state.autoLeft = 10;
    log('Auto-spin started (10 spins).');
    setButtons();
    spin();
  });

  resetBtn.addEventListener('click', () => {
    if(state.spinning) return;
    state.balance = 1000;
    state.bet = 10;
    state.lastWin = 0;
    state.autoLeft = 0;
    state.grid = makeEmptyGrid();
    renderGrid();
    updateHUD();
    log('Reset game state.');
    setButtons();
  });

  // -----------------------------
  // Init
  // -----------------------------
  renderGrid();
  updateHUD();
  log('Ready. Hit SPIN. (3+ scatters triggers a random bonus game.)');
  setButtons();
})();
</script>
</body>
</html>
